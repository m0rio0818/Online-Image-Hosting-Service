# PicShare
ユーザーアカウント不要で画像をアップロード、共有、表示できるオンライン画像ホスティングサービスです。

## URL
https://pic-share.nakatani.blog/

## Demo
![demo](https://github.com/m0rio0818/Online-Image-Hosting-Service/assets/72071848/91343df7-53d8-4570-bffd-5e6007e85655)

## 概要
PicShareは、ユーザーアカウント不要の画像共有サービスです。  
TOPページで「ファイルを選択」ボタンをクリックし、アップロードしたい画像を指定します。その後、「Upload Image」ボタンを押すことで、選択した画像がサーバーにアップロードされます。  
また、Add Publish Image Listにチェックをすると、画像を公開することができます。
アップロードが完了すると、モーダルに共有用URLと削除用URLが表示されます。  
共有用URLは他のユーザーと画像を共有するための手段で、このURLにアクセスすることで自身がアップロードした画像と閲覧数を確認できます。  
さらに、削除用URLへのアクセスにより、共有用URLを削除できるボタンが表示され、ユーザーは簡単に不要な共有を取り消すことができます。
なお、30日間アクセスがない画像を自動的にサーバーから削除する仕組みを導入し、データの整理を行っています

## 機能一覧
- 画像アップロード
- URL作成
- 閲覧数カウンター
- 手動での画像削除
- 一定期間アクセスがない画像の自動削除
- エラーハンドリング

## 作成の経緯
PicShareは、[Text Snippetter](https://text-snippet.nakatani.blog/)で得た経験を活かし、作成しました。
Text Snippetterでは3層アーキテクチャやサーバーサイドレンダリングを利用して、テキストを共有できるサービスを作成しました。  
これを基に、画像のアップロード、共有、表示、削除が可能なPicShareを開発しました。
ユーザーアカウントの作成を必要とせず、アップロードしたデータを簡単に削除できることを目標にしました。  
サーバー上のデータを効率的に管理するため、cronの活用も行いました。
<br>また、今回のプロジェクト作成により、以下の理解を深めることができました。
- 3層アーキテクチャ
- データベースのセットアップ
- envのセットアップ
- バックエンド言語を用いたデータベースの操作
- SQLインジェクション対策
- URLルーティング
- サーバサイドレンダリング
- cronによる定期実行

## 使用技術
### フロントエンド
| 項目                | 内容                         |
|---------------------|------------------------------|
| 使用言語            | HTML, CSS, Javascript        |
| CSSフレームワーク    | Tailwind CSS      |
| CSSアニメーション    | Animista                     |

### バックエンド
| 項目                | 内容                         |
|---------------------|------------------------------|
| 使用言語            | PHP                          |
| データベース        | MySQL                        |
| ジョブ管理ツール    | cron                         |
| Webサーバー         | NGINX                        |
| サーバー            | Amazon EC2                   |
| SSL/TLS証明書更新    | Certbot                      |


## ER図
当プロジェクトではマイグレーションを除いた場合、imagesテーブルのみを使用しています。
以下が、imagesテーブルのER図になります。 
![Images](https://github.com/m0rio0818/Online-Image-Hosting-Service/assets/72071848/d7eca47c-39c4-4a40-9891-8180cfc7e843)


## こだわった点
### ストレージ
画像の保存方法として、日付ベースでの管理方法を採用しました。
ファイル名には、一意になるようにhash関数を利用して設定しています。
具体的な手法としては、アップロードされた画像に対してランダムなハッシュを生成し、ファイル構造として、年/月/日と言った形の日付ベースでのディレクトリを作成しました。

画像のファイル名生成には以下の方法を採用しました。
```
hash('sha256', uniqid(mt_rand(), true)) . '.' . $extension
```
この手法では、乱数をもとにして生成されたユニークな識別子（uniqid）を SHA-256 ハッシュ関数にかけ、それにファイルの拡張子をつけることで、一意なファイル名を設定しています。


また、ディレクトリ構造は以下になっています。
```
Images/
|-- 2024/
    |-- 05/
        |-- 03/
        |   |-- {hash値}.png
        |-- 04/
            |-- {hash値}.png
            |-- {hash値}.jpeg
```


### cronを活用した自動的なストレージ最適化
システムのストレージを効果的に管理するために、cronを活用して30日間アクセスのない画像を自動的に削除する機能を導入しました。  
最初に、[checkLastAccess](https://github.com/m0rio0818/Online-Image-Hosting-Service/blob/main/Commands/Programs/CheckLastAccess.php)という独自コマンドを作成しました。  
このコマンドの作成により、ターミナルに```php console checkLastAccess```と入力することで、30日間アクセスのないデータと画像ファイルが削除されるようになりました。  

削除されたデータに関する情報は```Delete {filename}```がログとして標準出力され、30日間アクセスのないデータが1つもない場合は、```No data exceeds 30 days.```という形でログとして標準出力されます。  これにより、実行の結果を簡潔かつ明瞭に確認できるようにしました。 

cronで定期実行するために、[cron/lastAccessCheck.php](https://github.com/m0rio0818/Online-Image-Hosting-Service/blob/main/cron/lastAccessCheck.php)を作成し、以下のようにcronに登録しました。
```
0 0 * * * /path/to/php /path/to/cron/lastAccessCheck.php >> /path/to/cron/log.txt 2>&1
```
これにより、毎日定時に30日間アクセスのないデータが削除され、同時に以下のログがcron/log.txtに出力されます。  
なお、cron/log.txtは.gitignoreに登録しており、GitHub上では閲覧できません。

**log.txtの出力例**  
log.txtの出力例は以下の通りです。
```
<!-- 30日間アクセスがなかったデータが存在した場合 -->
2023-12-29 00:00:00
Array
(
    [0] => Starting an access check.......
    [1] => Delete /path/to/image
    [2] => Access check complete.
)

<!-- 削除するデータがなかった場合 -->
2023-12-30 00:00:00
Array
(
    [0] => Starting an access check.......
    [1] => No data exceeds 30 days.
)

<!-- エラーが発生した場合 -->
2023-12-31 00:00:00
PHP Warning:    ...
```

### セキュリティ
このプロジェクトでは、まず対応している画像形式を「png, jpeg, gif」に制限し、一度のアップロード容量を5MB、1日のアップロード総容量も5MBに設定しました。
ユーザーがこれらの条件を満たさない画像をアップロードした場合、エラーメッセージがユーザーに表示されます。

「1日にアップロードできる総容量」についてはIPアドレスごとに制限をかけ、悪意ある利用を防ぐための対策を実施しました。  
また、エラーメッセージの表示はユーザーが画像をアップロードした場合だけでなく、データベースに画像を保存する際やデータの取得に失敗した場合にも行うようにし、ユーザーが発生したエラーに対処しやすいようにしました。